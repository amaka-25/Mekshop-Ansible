---
- name: Generate SSH key and distribute to Ubuntu servers
  hosts: localhost
  vars:
    key_name: id_ansible
    key_path: ~/.ssh/{{ key_name }}
  tasks:
    - name: Generate SSH key pair if it does not exist
      openssh_keypair:
        path: "{{ key_path }}"
        type: rsa
        size: 4096
        force: false
        comment: "generated by Ansible"

- name: Distribute SSH public key to remote machines
  hosts: ubuntu_servers
  become: yes
  vars:
    key_name: id_ansible
    key_path: ~/.ssh/{{ key_name }}
  tasks:
    - name: Create .ssh directory if it doesn't exist
      file:
        path: /home/{{ ansible_user }}/.ssh
        state: directory
        mode: "0700"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    - name: Copy public key to authorized_keys
      authorized_key:
        user: "{{ ansible_user }}"
        state: present
        key: "{{ lookup('file', key_path + '.pub') }}"
